<div class="list-container">
  <!-- Top Toolbar -->
  <div class="toolbar">
    <div class="toolbar-left">
      <!-- Search -->
      <div class="search-group">
        <lucide-icon [img]="icons.Search" class="search-icon"></lucide-icon>
        <!--[(ngModel)]="searchQuery" this updates the searchQuery variable with the current text in the input-->
        <input
          type="text"
          placeholder="Search emails..."
          [(ngModel)]="searchQuery"
          class="search-input"
        />

        <app-search-options-modal
          [folders]="emailHandler.folders()"
          (search)="handleAdvancedSearch($event)"
          class="search-options-icon"
        />
      </div>

      <!-- Sort Dropdown (Native) -->
      <select [(ngModel)]="sortBy" class="sort-select" (change)="fetchMail()">
        <option selected value="DATE_DESC">DATE_DESC</option>
        <option value="DATE_ASC">DATE_ASC</option>
        <option value="PRIORITY">PRIORITY</option>
        <option value="SENDER">SENDER</option>
        <option value="UNREAD_FIRST">UNREAD_FIRST</option>
        <option value="SUBJECT">SUBJECT</option>
        <option value="BODY">BODY</option>
      </select>

      <!-- Refresh Button -->
      <button
        app-button
        variant="outline"
        size="icon"
        (click)="onRefresh()"
        [disabled]="isRefreshing()"
      >
        <lucide-icon [img]="icons.RefreshCw" [class.spin]="isRefreshing()"></lucide-icon>
      </button>

      <!-- View Mode Toggle -->
      <div class="view-toggle">
        <button
          class="toggle-btn"
          [class.active]="viewMode() === 'default'"
          (click)="viewMode.set('default')"
          title="Default View"
        >
          <lucide-icon [img]="icons.LayoutList" size="16"></lucide-icon>
        </button>
        <button
          class="toggle-btn"
          [class.active]="viewMode() === 'priority'"
          (click)="viewMode.set('priority')"
          title="Priority View"
        >
          <lucide-icon [img]="icons.LayoutGrid" size="16"></lucide-icon>
        </button>
      </div>
    </div>

    <!-- Bulk Actions (Conditional) -->
    @if (selectedIds().size > 0) {
    <div class="bulk-actions animate-fade-in">
      <span class="selection-count">{{ selectedIds().size }} selected</span>

      <!-- Move To Dropdown -->
      <select
        class="action-select"
        (change)="handleMove($any($event.target).value); $any($event.target).value = ''"
      >
        <option value="" disabled selected>Move to...</option>
        @for (folder of emailHandler.folders(); track folder.folderID) {
        <option [value]="folder.folderName">{{ folder.folderName }}</option>
        }
      </select>

      <button app-button variant="destructive" size="sm" (click)="handleDelete()">
        <lucide-icon [img]="icons.Trash2"></lucide-icon>
        Delete
      </button>
    </div>
    }
  </div>

  <!-- Email List Area -->
  <div class="email-scroll-area">
    @if (paginatedEmails().length === 0) {
    <div class="empty-state">
      <lucide-icon [img]="icons.Search" size="48" class="empty-icon"></lucide-icon>
      <h3>No emails found</h3>
      <p>Try adjusting your search or filters</p>
    </div>
    } @else {

    <!-- List Header (Select All) -->
    <div class="list-header">
      <div class="list-header-left">
        <input type="checkbox" (change)="toggleSelectAll($event)" />
        <span>Select all</span>
      </div>

      <div class="list-header-right">
        <span class="page-info">
          {{ (currentPage() - 1) * itemsPerPage() + 1 }} -
          {{ math.min(currentPage() * itemsPerPage(), processedEmails().length) }} of
          {{ processedEmails().length }}
        </span>

        <div class="pagination-buttons">
          <button
            app-button
            variant="ghost"
            size="icon"
            (click)="changePage(-1)"
            [disabled]="currentPage() === 1"
          >
            <lucide-icon [img]="icons.ChevronLeft"></lucide-icon>
          </button>
          <button
            app-button
            variant="ghost"
            size="icon"
            (click)="changePage(1)"
            [disabled]="currentPage === totalPages"
          >
            <lucide-icon [img]="icons.ChevronRight"></lucide-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Rows -->
    @for (email of paginatedEmails(); track email.id) {
    <div
      class="email-row"
      [class.unread]="!email.isRead"
      [class.selected]="selectedEmailId() === email.id"
      (click)="openEmail(email.id)"
    >
      <div class="row-checkbox" (click)="$event.stopPropagation()">
        <input
          type="checkbox"
          [checked]="selectedIds().has(email.id)"
          (change)="toggleEmailSelection(email.id, $event)"
        />
      </div>

      <div class="row-priority">
        @if (email.priority === 4) {
        <!-- URGENT: Red, Strong Up Arrow -->
        <lucide-icon [img]="icons.ChevronsUp" class="priority-urgent"></lucide-icon>
        } @else if (email.priority === 3) {
        <!-- HIGH: Orange/Amber, Up Arrow -->
        <lucide-icon [img]="icons.ChevronsUp" class="priority-high"></lucide-icon>
        } @else if (email.priority === 2) {
        <!-- NORMAL: Flag or Neutral Marker (No urgency implied) -->
        <lucide-icon [img]="icons.Flag" class="priority-normal"></lucide-icon>
        } @else if (email.priority === 1) {
        <!-- LOW: Blue/Green, Down Arrow -->
        <lucide-icon [img]="icons.ChevronsDown" class="priority-low"></lucide-icon>
        }
      </div>

      <div class="row-content">
        <div class="row-top">
          <span class="sender-name">{{ email.sender.name }}</span>
          @if (email.hasAttachments) {
          <span class="attachment-badge">ðŸ“Ž</span>
          }
        </div>
        <div class="subject-line">{{ email.subject }}</div>
        <div class="preview-line">{{ email.preview }}</div>
      </div>

      <div class="row-date">
        {{ formatDate(email.sentAt) }}
      </div>
    </div>
    } }
  </div>

  <!-- Pagination -->
  @if (totalPages() > 1) {
  <div class="pagination">
    <span>Page {{ currentPage() }} of {{ totalPages() }}</span>
    <div class="pagination-controls">
      <button
        app-button
        variant="outline"
        size="sm"
        (click)="changePage(-1)"
        [disabled]="currentPage() === 1"
      >
        <lucide-icon [img]="icons.ChevronLeft"></lucide-icon> Previous
      </button>
      <button
        app-button
        variant="outline"
        size="sm"
        (click)="changePage(1)"
        [disabled]="currentPage === totalPages"
      >
        Next <lucide-icon [img]="icons.ChevronRight"></lucide-icon>
      </button>
    </div>
  </div>
  }
</div>
